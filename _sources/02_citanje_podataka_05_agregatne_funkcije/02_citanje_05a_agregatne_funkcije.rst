.. -*- mode: rst -*-

Агрегатне функције (SUM, AVG, MIN, MAX, COUNT)
----------------------------------------------

У применама је вемоа често потребно да се израчунају одређене статистике серија
података. То може да буде збир, производ, просек тј. аритметичка средина,
најмања или највећа вредност и слично. Приликом израчунавања ових
статистика од серије елемената (тј. од свих елемената једне колоне
табеле) гради се један резултат тј. сви подаци се агрегирају у
јединствен резултат. Зато се ове функције називају **агрегатне
функције**.

Илуструјмо набројане функције на неколико примера. 

Збир елемената
''''''''''''''

Збир елемената неке колоне може да се добије агрегатном функцијом
``SUM``.

.. questionnote::
   
   Приказати укупан фонд часова свих предмета.

.. code-block:: sql

   SELECT SUM(fond)
   FROM predmet;

Извршавањем упита добија се следећи резултат:

.. csv-table::
   :header:  "SUM(fond)"
   :align: left

   "130"

Овај упит можемо да прочитамо као 

| **ОДАБЕРИ** збир колоне `фонд`
| **ИЗ РЕДОВА** табеле `предмет`

Примећујемо да је назив колоне резултата исти као израз употребљен 
након речи ``SELECT``, овде ``SUM(fond)``. То можемо да променимо 
навођењем тзв. **алијаса** након кључне речи ``AS``.

.. code-block:: sql
                
   SELECT SUM(fond) AS ukupan_fond
   FROM predmet;

Извршавањем упита добија се следећи резултат:

.. csv-table::
   :header:  "ukupan_fond"
   :align: left

   "130"

Агрегатне функције се веома често примењују након филтрирања
(селекције само неких врста).

.. questionnote::
   
   Приказати укупан фонд часова предмета из првог разреда.
 
.. code-block:: sql
                
   SELECT SUM(fond) AS ukupan_fond
   FROM predmet
   WHERE razred = 1;

Извршавањем упита добија се следећи резултат:

.. csv-table::
   :header:  "ukupan_fond"
   :align: left

   "33"

Овај упит можемо да прочитамо као:

| **ОДАБЕРИ** збир колоне `фонд`, означен **КАО** `укупан фонд`
| **ИЗ РЕДОВА** табеле `предмет`
| **КОД КОЈИХ** је разред једнак 1


Агрегатне функције се могу применити и на изразе. Илуструјмо то
следећим примером.

.. questionnote::

   Под претпоставком да постоји 37 радних недеља, прикажи укупан
   годишњи фонд часова свих предмета у другом разреду.

.. code-block:: sql

   SELECT SUM(37 * fond) AS ukupan_godisnji_fond
   FROM predmet
   WHERE razred = 2;

Извршавањем упита добија се следећи резултат:

.. csv-table::
   :header:  "ukupan_godisnji_fond"
   :align: left

   "1221"



Просек елемената
''''''''''''''''

Просек (аритметичка средина) елемената неке колоне може да се добије
агрегатном функцијом ``AVG``.

.. questionnote::

   Приказати просечну оцену из предмета са идентификатором 1
   
.. code-block:: sql

   SELECT AVG(ocena) AS prosecna_ocena
   FROM ocena
   WHERE id_predmet = 1;

Извршавањем упита добија се следећи резултат:

.. csv-table::
   :header:  "prosecna_ocena"
   :align: left

   "3.407063197026022"


Просечне вредности се обично заокружују на одређен број
децимала. Подсетимо се, заокруживање може да се изврши применом
функције ``round``. Приметимо да се у том случају гради израз у коме
учествује резултат агрегатне функције (на резултат агрегатне функције
се могу примењивати уобичајени оператори и функције).

.. code-block:: sql

   SELECT round(AVG(ocena), 2) AS prosecna_ocena
   FROM ocena
   WHERE id_predmet = 1;

Извршавањем упита добија се следећи резултат:

.. csv-table::
   :header:  "prosecna_ocena"
   :align: left

   "3.41"

Најмања и највећа вредност
''''''''''''''''''''''''''
   
Најмању вредност у некој колони можемо да одредимо функцијом ``MIN``, а
највећу функцијом ``MAX``. Ове функције могу да се примене и на бројеве
и на ниске и на датуме (при чему је у случају примене на ниске веома
битно која колациона секвенца се користи).
   
.. questionnote::

   Приказати најнижу оцену на писменом задатку из математике
   одржаном 15. октобра 2020 (та математика има идентификатор 1).
   
.. code-block:: sql
                
   SELECT MIN(ocena) AS najniza_ocena
   FROM ocena
   WHERE id_predmet = 1 AND datum = '2020-10-15' AND vrsta = 'писмени задатак';

Извршавањем упита добија се следећи резултат:

.. csv-table::
   :header:  "najniza_ocena"
   :align: left

   "1"

.. questionnote::

   Приказати датум када је у дневник уписана последња оцена из српског
   језика за први разред
   
.. code-block:: sql

   SELECT MAX(datum) AS poslednji_datum
   FROM ocena
   WHERE id_predmet = 2;

Извршавањем упита добија се следећи резултат:

.. csv-table::
   :header:  "poslednji_datum"
   :align: left

   "2021-05-10"


.. questionnote::

   Прикажи име и презиме ученика у одељењу IV1 који је први у дневнику
   (ученици се сортирају по азбучном редоследу).

Агрегатне функције могу да се примене и на колоне које се израчунавају
као вредности неког израза. У овом случају то је израз којим ће се
надовезати ниске које чине презиме и име. Пошто се тражи поређење
ниски по азбучном редоследу, а ова изведена колона нема подешену
колациону секвенцу, то морамо урадити у оквиру самог упита.

.. code-block:: sql

   SELECT MIN((prezime || ' ' || ime) COLLATE UNICODE) AS prvi_u_dnevniku
   FROM ucenik
   WHERE razred = 4 AND odeljenje = 1;

Извршавањем упита добија се следећи резултат:

.. csv-table::
   :header:  "prvi_u_dnevniku"
   :align: left

   "Васиљевић Дејан"

Број елемената
''''''''''''''

Често желимо да одредимо број елемената неке серије. У случају упита
читања података из база то се најчешће своди на то да се изброје врсте
у резултату упита. За то се користи агрегатна функција
``COUNT``. Пошто је број врста у резултату једнак броју елемената
сваке појединачне колоне, обично се уместо назива колоне, као аргумент
ове функције просто наводи звездица ``*``.
   
.. questionnote::

   Приказати број ученика у табели ученика.

.. code-block:: sql
                
   SELECT COUNT(*) AS broj_ucenika
   FROM ucenik;

Извршавањем упита добија се следећи резултат:

.. csv-table::
   :header:  "broj_ucenika"
   :align: left

   "346"

Овај упит можемо да прочитамо као:

| **ОДАБЕРИ** број редова резултата, означен **КАО** `број ученика`
| **ИЗ РЕДОВА** табеле `ученик`

Исти резултат би се добио ако би се тражило пребројавање елемената било
које конкретне колоне. На пример.

.. code-block:: sql
                
   SELECT COUNT(ime) AS broj_ucenika
   FROM ucenik;

Извршавањем упита добија се следећи резултат:

.. csv-table::
   :header:  "broj_ucenika"
   :align: left

   "346"

И пребројавање често иде у комбинацији са филтрирањем (селекцијом само
неких врста).
   
.. questionnote::

   Приказати укупан број предмета у првом разреду
   
.. code-block:: sql

   SELECT COUNT(*) AS broj_predmeta
   FROM predmet
   WHERE razred = 1;

Извршавањем упита добија се следећи резултат:

.. csv-table::
   :header:  "broj_predmeta"
   :align: left

   "16"

Агрегатне функције могу да се комбинују и са елиминисањем дупликата.

.. questionnote::

   Приказати укупан број различитих презимена ученика.

   
.. code-block:: sql

   SELECT COUNT(*) AS broj_ucenika, COUNT(DISTINCT prezime) AS broj_prezimena
   FROM ucenik;

Извршавањем упита добија се следећи резултат:

.. csv-table::
   :header:  "broj_ucenika", "broj_prezimena"
   :align: left

   "346", "114"


Вежба
.....

   
Наредних неколико упита покушај да напишеш самостално.

.. questionnote::

   Одредити први и последњи датум када је неки ученик добио оцену.

.. dbpetlja:: db_agregatne_funkcije_01
   :dbfile: dnevnik.sql
   :solutionquery: SELECT MIN(datum), MAX(datum)
                   FROM ocena
   :showresult:
   
.. questionnote::

   Одредити број јединица које су ученици добили на писменим задацима.
   
.. dbpetlja:: db_agregatne_funkcije_02
   :dbfile: dnevnik.sql
   :solutionquery: SELECT COUNT(*)
                   FROM ocena
                   WHERE ocena = 1 AND vrsta = 'писмени задатак'
   :showresult:

.. questionnote::

   Одредити просечну оцену ученика на контролним вежбама одржаним током новембра
   2020. године.
   
.. dbpetlja:: db_agregatne_funkcije_03
   :dbfile: dnevnik.sql
   :solutionquery: SELECT AVG(ocena)
                   FROM ocena
                   WHERE datum LIKE '2020-11-%' AND vrsta = 'контролна вежба'
   :showresult:
                   
.. questionnote::

   Одредити број предмета из којих је држан писмени задатак. Колону
   назвати број предмета.
   
.. dbpetlja:: db_agregatne_funkcije_04
   :dbfile: dnevnik.sql
   :solutionquery: SELECT COUNT(DISTINCT id_predmet) AS broj_predmeta
                   FROM ocena
                   WHERE vrsta = 'писмени задатак'
   :showresult:
   :checkcolumnname:
